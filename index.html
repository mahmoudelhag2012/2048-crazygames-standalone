<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 â€” Web Standalone (CrazyGames)</title>

  <!-- Ù…ÙÙŠØ´ Telegram / AdsGram / Telega Ù‡Ù†Ø§ -->

  <style>
    :root{ --bg:#faf8ef; --board:#bbada0; --tile:#cdc1b4; --text:#776e65; --btn:#8f7a66; --white:#fff; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial;padding:16px;margin:0;background:var(--bg);color:var(--text);}
    .wrap{max-width:480px;margin:0 auto;position:relative}
    h1{margin:0 0 8px;font-size:32px;line-height:1.1;padding-right:50px}
    .top{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
    .card{background:var(--board);color:var(--white);border-radius:12px;padding:8px 12px;min-width:100px;text-align:center}
    .grid{background:var(--board);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;touch-action:none}
    .cell{height:80px;background:var(--tile);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px}
    button{padding:10px 12px;border:0;border-radius:12px;font-weight:700;background:var(--btn);color:var(--white);cursor:pointer}
    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px;justify-items:center;align-items:center}
    .controls .spacer{height:0}
    .arrow{min-width:96px;min-height:66px;font-size:20px}
    .menuBtn{position:absolute;top:8px;right:8px;width:32px;height:32px;padding:0;min-width:0;min-height:0;line-height:1;background:transparent;color:var(--btn);border:2px solid var(--btn);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;z-index:11}
    .backdrop{position:fixed;inset:0;background:#0007;display:none}
    .backdrop.show{display:block}
    .drawer{position:fixed;top:0;right:0;height:100dvh;width:220px;background:#f5efe6;box-shadow:0 0 30px #0003;padding:16px 14px;transform:translateX(100%);transition:transform .25s ease;z-index:12}
    .drawer.open{transform:translateX(0)}
    .drawer h3{margin:4px 0 12px}
    .menuItem{display:block;width:100%;margin:8px 0;padding:12px 14px;background:var(--btn);color:#fff;border:0;border-radius:12px;font-weight:700;cursor:pointer}
    .menuInfo{margin:6px 0 10px;font-weight:700;color:#333}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    small{opacity:.7}

    /* Splash */
    .splash{
      position:fixed;inset:0;z-index:1000;
      background:radial-gradient(120% 120% at 50% -20%,#fdf7ea 0%,#efe6d9 45%,#e7dccf 100%);
      display:none; align-items:center;justify-content:center;
      transition:opacity .35s ease,visibility .35s ease;
    }
    .splash.show{display:flex}
    .splash.hide{opacity:0;visibility:hidden}
    .splash-card{width:min(88vw,420px);background:#ffffffcc;border:1px solid #e9dfd3;border-radius:18px;box-shadow:0 10px 30px #00000014;padding:18px 18px 14px;text-align:center;backdrop-filter:blur(4px)}
    .splash-logo{width:100%;height:auto;border-radius:12px;display:block}
    .splash-title{margin:10px 0 6px;font-weight:800;letter-spacing:.4px;color:#5a4a3d}
    .splash-sub{margin:0 0 8px;color:#7b6d61;font-weight:600;font-size:14px}
    .bar{height:8px;width:100%;background:#eadfce;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#8f7a66,#b59d84);border-radius:999px;animation:fill 2.2s ease forwards}
    @keyframes fill{to{width:100%}}
    .tap-hint{margin-top:8px;font-size:12px;color:#998a7f}
  </style>
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash">
  <div class="splash-card" id="splashCard">
    <img id="splashImg" class="splash-logo" alt="Collect Coins â€” 2048">
    <h3 class="splash-title">Collect coins while you play</h3>
    <p class="splash-sub">Watch an ad at milestones to earn bonus coins</p>
    <div class="bar"><span></span></div>
    <div class="tap-hint">Tap to continue</div>
  </div>
</div>

<div class="wrap">
  <h1>2048 Mini</h1>
  <button id="menuBtn" class="menuBtn" aria-label="Menu">â˜°</button>

  <div class="top">
    <div class="card">Score<br><b id="score">0</b></div>
    <div class="card">Best<br><b id="best">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="controls">
    <span class="spacer"></span>
    <button id="up" class="arrow">â–²</button>
    <span class="spacer"></span>
    <button id="left" class="arrow">â—€</button>
    <button id="down" class="arrow">â–¼</button>
    <button id="right" class="arrow">â–¶</button>
  </div>

  <p><small>Swipe on the board or use the arrows. Standalone build.</small></p>
</div>

<div id="backdrop" class="backdrop"></div>
<div id="drawer" class="drawer">
  <h3>Menu</h3>
  <div class="menuInfo">Coins: <span id="coins" class="mono">0</span></div>
  <div class="menuInfo">Extra Lives: <span id="lives" class="mono">0</span></div>
  <button id="mNew" class="menuItem">New Game</button>
  <button id="mInvite" class="menuItem">Copy Game Link</button>
  <button id="mShare" class="menuItem">Share</button>
  <button id="mAbout" class="menuItem">About</button>
  <button id="mClaim" class="menuItem" style="display:none">Convert Coins (Coming soon)</button>
</div>

<script>
/* =================== Ø£Ù…Ø§Ù† Ø¹Ø§Ù… =================== */
window.addEventListener('error', e => { try{ console.warn(e.message); }catch(_){} });

/* =================== CrazyGames SDK (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ===================
   Ø§Ù„Ù…Ù†ØµØ© Ø¨ØªØ­Ù‚Ù† SDK ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù‡Ù†Ø§ Ø¢Ù…Ù†Ø© Ø¨Ù€ optional chaining.
*/
const CG = window.CrazyGames?.SDK;
function cgLoadingStart(){ try{ CG?.game?.loadingStart?.(); }catch(_){} }
function cgLoadingStop(){  try{ CG?.game?.loadingStop?.();  }catch(_){} }
async function showInterstitialAd(){ try{ await CG?.ad?.requestAd?.('midgame'); }catch(_){} }
async function showRewardAd(){ try{ await CG?.ad?.requestAd?.('rewarded'); return true; }catch(_){ return false; } }

/* =================== Splash =================== */
const SPLASH_IMG_URL = "./assets/splash.png"; // Ø­Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¯ÙŠ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ assets
const splash = document.getElementById('splash');
const splashImg = document.getElementById('splashImg');
function hideSplash(){ splash.classList.add('hide'); setTimeout(()=> splash.style.display='none', 400); }
function showSplash(){ splash.classList.remove('hide'); splash.classList.add('show'); }
try{
  splashImg.src = SPLASH_IMG_URL;
  splashImg.onload = ()=>{ showSplash(); setTimeout(hideSplash, 1600); };
  splashImg.onerror = ()=> hideSplash();
  splash.addEventListener('click', hideSplash);
}catch(_){ hideSplash(); }

/* =================== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© =================== */
const size=4; let grid=[], score=0, best=+localStorage.getItem('best2048')||0;
const gridEl=document.getElementById('grid'); const scoreEl=document.getElementById('score'); const bestEl=document.getElementById('best');

/* =================== Coins / Rewards =================== */
const coinsEl = document.getElementById('coins');
function getCoins(){ return +(localStorage.getItem('coins')||'0'); }
function setCoins(v){ v=Math.max(0,Math.floor(v)); localStorage.setItem('coins',String(v)); updateCoinsUI(); }
function updateCoinsUI(){
  const c = getCoins();
  coinsEl.textContent = c;
  document.getElementById('mClaim').style.display = c>=100 ? 'block' : 'none'; // Ù…Ø«Ø§Ù„: ÙŠØ¸Ù‡Ø± Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ 100 Ø¹Ù…Ù„Ø©
}
updateCoinsUI();

/* Ø²Ø± "Convert Coins" â€” Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„ØªØ¬Ù…ÙŠÙ„ÙŠ ÙÙ‚Ø· */
document.getElementById('mClaim').onclick = () => {
  alert("Coming soon: conversions & leaderboards.");
};

/* Daily Bonus (Ù…Ø±Ù‘Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¹Ù„Ø§Ù†) */
const DAILY_BONUS_AMOUNT = 5;
const DAILY_BONUS_KEY    = 'dailyBonusDate';
let   dailyBonusPrompted = false;
function _todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function hasClaimedDailyBonusToday(){ return localStorage.getItem(DAILY_BONUS_KEY) === _todayKey(); }
function markDailyBonusClaimed(){ localStorage.setItem(DAILY_BONUS_KEY, _todayKey()); }
function maybeOfferDailyBonusInt(){
  if (hasClaimedDailyBonusToday() || dailyBonusPrompted) return;
  dailyBonusPrompted = true;
  const ok = confirm(`ðŸŽ Daily Bonus\nWatch an ad to get ${DAILY_BONUS_AMOUNT} coins?`);
  if (!ok) return;
  showRewardAd().then(ok=>{
    if(ok){ setCoins(getCoins() + DAILY_BONUS_AMOUNT); markDailyBonusClaimed(); alert(`âœ… +${DAILY_BONUS_AMOUNT} coins`); }
    else { alert('Ad not available now.'); }
  });
}

/* Extra Lives (ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ø¦Ù…) */
function getExtraLives(){ return +(localStorage.getItem('extraLives') || '0'); }
function setExtraLives(v){ v=Math.max(0, v|0); localStorage.setItem('extraLives', String(v)); updateLivesUI(); }
function updateLivesUI(){ document.getElementById('lives').textContent = getExtraLives(); }
updateLivesUI();

/* Ù…ÙƒØ§ÙØ¢Øª milestones (Ø£Ø±Ù‚Ø§Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠØ©) */
const baseRewards={256:10,512:20,1024:50,2048:100};
let msRunCount={256:0,512:0,1024:0,2048:0};
let msSeenTilesInRun={256:0,512:0,1024:0,2048:0};
let reached2048InRun=false;

function offerAndMaybeAward(ms,tier){
  const base=baseRewards[ms]; if(!base) return;
  const amount=tier==='full'?base:Math.ceil(base/2);
  const want=confirm(`Milestone ${ms}!\n${tier==='full'?'Claim ':'Claim (half) '}${amount} coins after a short ad?`);
  if(!want) return;
  showRewardAd().then(ok=>{
    if(!ok) return;
    setCoins(getCoins()+amount);
    if (ms===512 || ms===2048) setExtraLives(getExtraLives()+1);
    alert(`âœ… +${amount} coins${(ms===512||ms===2048)?' + Extra Life':''}`);
  });
}

/* =================== Ù„ÙˆØ¬ÙŠÙƒ 2048 =================== */
function emptyGrid(){grid=Array.from({length:size},()=>Array(size).fill(0));}
function randomEmpty(){const e=[]; for(let r=0;r<size;r++)for(let c=0;c<size;c++)if(!grid[r][c])e.push([r,c]); return e.length?e[Math.floor(Math.random()*e.length)]:null;}
function addTile(){const pos=randomEmpty(); if(!pos) return false; grid[pos[0]][pos[1]] = Math.random()<0.9?2:4; return true;}
function setup(){ emptyGrid(); addTile(); addTile(); score=0; msRunCount={256:0,512:0,1024:0,2048:0}; msSeenTilesInRun={256:0,512:0,1024:0,2048:0}; reached2048InRun=false; draw(); }

function draw(){
  gridEl.innerHTML=''; scoreEl.textContent=score; bestEl.textContent=best;
  const currentCounts={256:0,512:0,1024:0,2048:0};
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    const d=document.createElement('div'); d.className='cell'; d.textContent=v||''; d.style.background=v?tileColor(v):'#cdc1b4'; d.style.color=v>=8?'#f9f6f2':'#776e65'; gridEl.appendChild(d);
    if(v===256||v===512||v===1024||v===2048) currentCounts[v]++;
  }
  [256,512,1024,2048].forEach(ms=>{
    const prev=msSeenTilesInRun[ms]||0, now=currentCounts[ms]||0, delta=Math.max(0,now-prev);
    if(delta>0){
      for(let i=0;i<delta;i++){
        let tier='none';
        if(msRunCount[ms]===0) tier='full';
        else if(reached2048InRun) tier='half';
        if(ms===2048&&msRunCount[2048]===0) reached2048InRun=true;
        msRunCount[ms]++;
        if(tier==='full') offerAndMaybeAward(ms,'full');
        else if(tier==='half') offerAndMaybeAward(ms,'half');
      }
      msSeenTilesInRun[ms]=now;
    } else msSeenTilesInRun[ms]=now;
  });
}
function tileColor(v){const m={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'}; return m[v]||'#3c3a32';}
function slide(row){const f=row.filter(x=>x); for(let i=0;i<f.length-1;i++){ if(f[i]===f[i+1]){ f[i]*=2; score+=f[i]; f.splice(i+1,1);} } while(f.length<size) f.push(0); return f;}
function rotate(times){for(let t=0;t<times;t++){const g=Array.from({length:size},()=>Array(size).fill(0)); for(let r=0;r<size;r++)for(let c=0;c<size;c++) g[c][size-1-r]=grid[r][c]; grid=g;}}

function move(dir){
  const before=JSON.stringify(grid);
  if(dir===2) rotate(2); else if(dir===1) rotate(3); else if(dir===3) rotate(1);
  for(let r=0;r<size;r++) grid[r]=slide(grid[r]);
  if(dir===2) rotate(2); else if(dir===1) rotate(1); else if(dir===3) rotate(3);
  const after=JSON.stringify(grid);
  if(before!==after){ addTile(); updateBest(); draw(); if(gameOver()) endGame(); }
}
function gameOver(){ if(randomEmpty()) return false; for(let r=0;r<size;r++)for(let c=0;c<size;c++){const v=grid[r][c]; if(r+1<size&&grid[r+1][c]===v) return false; if(c+1<size&&grid[r][c+1]===v) return false;} return true; }
function updateBest(){ if(score>best){ best=score; localStorage.setItem('best2048',best);} }

/* Ø³ÙˆØ§ÙŠØ¨/Ù…Ø§ÙˆØ³ */
const startPos={x:0,y:0}; let dragging=false;
function touchStart(e){dragging=true; const t=e.touches?e.touches[0]:e; startPos.x=t.clientX; startPos.y=t.clientY;}
function touchEnd(e){ if(!dragging) return; dragging=false; const t=e.changedTouches?e.changedTouches[0]:e; const dx=t.clientX-startPos.x, dy=t.clientY-startPos.y; if(Math.abs(dx)>Math.abs(dy)){ move(dx>0?2:0);} else { move(dy>0?3:1);} }
gridEl.addEventListener('touchstart',touchStart);
gridEl.addEventListener('touchend',touchEnd);
gridEl.addEventListener('mousedown',touchStart);
gridEl.addEventListener('mouseup',touchEnd);

/* Ø£Ø²Ø±Ø§Ø± */
document.getElementById('left').onclick=()=>move(0);
document.getElementById('up').onclick=()=>move(1);
document.getElementById('right').onclick=()=>move(2);
document.getElementById('down').onclick=()=>move(3);

/* Ù…Ù†ÙŠÙˆ */
const menuBtn=document.getElementById('menuBtn'); const drawer=document.getElementById('drawer'); const backdrop=document.getElementById('backdrop');
function openDrawer(){ drawer.classList.add('open'); backdrop.classList.add('show'); }
function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); }
menuBtn.addEventListener('click', openDrawer); backdrop.addEventListener('click', closeDrawer);
document.getElementById('mNew').onclick=()=>{ closeDrawer(); setup(); };
document.getElementById('mInvite').onclick=()=>{ closeDrawer(); prompt('Copy link:', location.href); };
document.getElementById('mShare').onclick=()=>{ closeDrawer(); const text=`I scored ${score} in 2048!`; if(navigator.share){navigator.share({text, url: location.href});} else {prompt('Copy and share:', text + ' ' + location.href);} };
document.getElementById('mAbout').onclick = () => {
  closeDrawer();
  alert(`2048 Mini â€” Web Standalone
â€¢ Play, reach milestones (256/512/1024/2048) and earn coins.
â€¢ Interstitial/Rewarded ads (CrazyGames SDK) may appear between rounds.
â€¢ Extra Life is granted at 512 and 2048 once per run.
â€¢ Your best score, coins and lives are stored locally.`);
};

/* revive + endGame (Ù…Ø¹ Extra Life Ø£ÙˆÙ„Ø§Ù‹) */
function reviveBoard(){
  const pref=[2,4,8,16,32,64,128,256,512,1024,2048];
  for(const val of pref){
    const spots=[];
    for(let r=0;r<size;r++) for(let c=0;c<size;c++) if(grid[r][c]===val) spots.push([r,c]);
    if(spots.length){ const [rr,cc]=spots[Math.floor(Math.random()*spots.length)]; grid[rr][cc]=0; updateBest(); return; }
  }
}
function endGame(){
  const lives=getExtraLives();
  if(lives>0){ setExtraLives(lives-1); reviveBoard(); draw(); alert('ðŸ”¥ Extra Life used!'); return; }
  if(confirm("Game over! Your score: "+score+"\nWatch an ad to continue?")){
    showRewardAd().then(ok=>{ if(ok){ reviveBoard(); draw(); } else { showInterstitialAd().finally(()=> alert("Game ended! Final score: "+score)); } });
  } else {
    showInterstitialAd().finally(()=> alert("Game ended! Final score: "+score));
  }
}

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ */
cgLoadingStart();
window.addEventListener('load', () => {
  setup();
  cgLoadingStop();
  setTimeout(maybeOfferDailyBonusInt, 1500);
});
</script>
</body>
</html>
