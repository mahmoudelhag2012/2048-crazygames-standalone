<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 Rush+ — Standalone (CrazyGames)</title>

  <!-- لا توجد مكتبات خارجية. CrazyGames SDK يُحقن من المنصة نفسها. -->

  <style>
    :root{
      --bg:#faf8ef; --board:#bbada0; --tile:#cdc1b4; --text:#776e65; --btn:#8f7a66; --white:#fff;
    }
    *{ box-sizing:border-box }
    body{ font-family:system-ui,Arial; padding:16px; margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:520px; margin:0 auto; position:relative }
    h1{ margin:0 0 8px; font-size:32px; line-height:1.1; padding-right:50px }
    .top{ display:flex; gap:8px; justify-content:center; margin-bottom:8px; flex-wrap:wrap }
    .card{ background:var(--board); color:var(--white); border-radius:12px; padding:8px 12px; min-width:110px; text-align:center }
    .grid{ background:var(--board); border-radius:12px; padding:8px; display:grid; gap:8px; touch-action:none }
    .cell{
      height:80px; background:var(--tile); border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:24px; transition:transform .08s ease;
    }
    .cell.pop{ transform:scale(1.05) }
    button{ padding:10px 12px; border:0; border-radius:12px; font-weight:700; background:var(--btn); color:var(--white); cursor:pointer }
    .controls{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:14px; justify-items:center; align-items:center }
    .controls .spacer{ height:0 }
    .arrow{ min-width:96px; min-height:66px; font-size:20px }
    .menuBtn{
      position:absolute; top:8px; right:8px; width:32px; height:32px; padding:0; line-height:1;
      background:transparent; color:var(--btn); border:2px solid var(--btn);
      border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; z-index:11
    }
    .backdrop{ position:fixed; inset:0; background:#0007; display:none }
    .backdrop.show{ display:block }
    .drawer{
      position:fixed; top:0; right:0; height:100dvh; width:260px; background:#f5efe6; box-shadow:0 0 30px #0003;
      padding:16px 14px; transform:translateX(100%); transition:transform .25s ease; z-index:12
    }
    .drawer.open{ transform:translateX(0) }
    .drawer h3{ margin:4px 0 12px }
    .menuItem{ display:block; width:100%; margin:8px 0; padding:12px 14px; background:var(--btn); color:#fff; border:0; border-radius:12px; font-weight:700; cursor:pointer }
    .menuInfo{ margin:6px 0 10px; font-weight:700; color:#333 }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
    small{ opacity:.7 }

    /* Splash */
    .splash{
      position:fixed; inset:0; z-index:1000;
      background:radial-gradient(120% 120% at 50% -20%,#fdf7ea 0%,#efe6d9 45%,#e7dccf 100%);
      display:none; align-items:center; justify-content:center;
      transition:opacity .35s ease, visibility .35s ease;
    }
    .splash.show{ display:flex }
    .splash.hide{ opacity:0; visibility:hidden }
    .splash-card{
      width:min(88vw,420px); background:#ffffffcc; border:1px solid #e9dfd3; border-radius:18px; box-shadow:0 10px 30px #00000014;
      padding:18px 18px 14px; text-align:center; backdrop-filter:blur(4px)
    }
    .splash-logo{ width:100%; height:auto; border-radius:12px; display:block }
    .splash-title{ margin:10px 0 6px; font-weight:800; letter-spacing:.4px; color:#5a4a3d }
    .splash-sub{ margin:0 0 8px; color:#7b6d61; font-weight:600; font-size:14px }
    .bar{ height:8px; width:100%; background:#eadfce; border-radius:999px; overflow:hidden }
    .bar>span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#8f7a66,#b59d84); border-radius:999px; animation:fill 1.6s ease forwards }
    @keyframes fill{ to{ width:100% } }
    .tap-hint{ margin-top:8px; font-size:12px; color:#998a7f }

    /* Mode dialog */
    .mode-dlg{
      position:fixed; inset:0; z-index:900; background:#00000099; display:flex; align-items:center; justify-content:center;
    }
    .mode-card{
      width:min(92vw,520px); background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px #00000022
    }
    .mode-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .mode-btn{ padding:14px; border-radius:12px; border:2px solid #e6ddd2; background:#fff; color:#5a4a3d; cursor:pointer; text-align:left }
    .mode-btn b{ display:block; margin-bottom:4px }
    .mode-row{ display:flex; gap:8px; align-items:center; margin-top:10px }
    .size-btn{ padding:8px 10px; border-radius:10px; border:2px solid #e6ddd2; background:#fff; cursor:pointer }
    .size-btn.active{ background:#8f7a66; color:#fff; border-color:#8f7a66 }
  </style>
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash" aria-hidden="true">
  <div class="splash-card" id="splashCard">
    <img id="splashImg" class="splash-logo" alt="2048 — splash">
    <h3 class="splash-title">Reach milestones, earn rewards</h3>
    <p class="splash-sub">Short rewarded ads may appear on milestones</p>
    <div class="bar"><span></span></div>
    <div class="tap-hint">Tap to continue</div>
  </div>
</div>

<!-- Mode dialog -->
<div id="modeDlg" class="mode-dlg" style="display:none">
  <div class="mode-card">
    <h3 style="margin:4px 0 10px;color:#5a4a3d">Choose mode</h3>
    <div class="mode-grid">
      <button class="mode-btn" data-mode="classic"><b>Classic</b><span>Original 2048 rules.</span></button>
      <button class="mode-btn" data-mode="rush"><b>Time Rush</b><span>60s timer, +1s per merge.</span></button>
      <button class="mode-btn" data-mode="daily"><b>Daily</b><span>Same start for everyone today.</span></button>
      <button class="mode-btn" data-mode="classic5"><b>Big Board</b><span>5×5 — easier combos.</span></button>
    </div>
    <div class="mode-row">
      <span style="min-width:80px">Board:</span>
      <button class="size-btn" data-size="3">3×3</button>
      <button class="size-btn active" data-size="4">4×4</button>
      <button class="size-btn" data-size="5">5×5</button>
    </div>
  </div>
</div>

<div class="wrap">
  <h1>2048 Rush+</h1>
  <button id="menuBtn" class="menuBtn" aria-label="Menu">☰</button>

  <div class="top">
    <div class="card">Score<br><b id="score">0</b></div>
    <div class="card">Best<br><b id="best">0</b></div>
    <div class="card" id="timeCard" style="display:none">Time<br><b id="timeLeft">60</b></div>
  </div>

  <div id="grid" class="grid" role="application" aria-label="2048 board"></div>

  <div class="controls" aria-label="On-screen controls">
    <span class="spacer"></span>
    <button id="up" class="arrow" aria-label="Move up">▲</button>
    <span class="spacer"></span>
    <button id="left" class="arrow" aria-label="Move left">◀</button>
    <button id="down" class="arrow" aria-label="Move down">▼</button>
    <button id="right" class="arrow" aria-label="Move right">▶</button>
  </div>

  <p><small>Swipe, use the arrows or keyboard (↑←↓→). Modes: Classic, Time Rush, Daily.</small></p>
</div>

<div id="backdrop" class="backdrop" aria-hidden="true"></div>
<div id="drawer" class="drawer" aria-hidden="true" aria-label="Menu">
  <h3>Menu</h3>
  <div class="menuInfo">Mode: <span id="modeLbl" class="mono">classic</span></div>
  <div class="menuInfo">Undo left: <span id="undoLeft" class="mono">1</span></div>
  <button id="mNew" class="menuItem">New Game</button>
  <button id="mUndo" class="menuItem">Undo move</button>
  <button id="mMode" class="menuItem">Change mode</button>
  <button id="mAbout" class="menuItem">About</button>
</div>

<script>
/* ========= Safety ========= */
window.addEventListener('error', e => { try{ console.warn(e.message); }catch(_){} });

/* ========= CrazyGames SDK (optional) ========= */
const CG = window.CrazyGames?.SDK;
function cgLoadingStart(){ try{ CG?.game?.loadingStart?.(); }catch(_){} }
function cgLoadingStop(){  try{ CG?.game?.loadingStop?.();  }catch(_){} }
async function showInterstitialAd(){ try{ await CG?.ad?.requestAd?.('midgame'); }catch(_){} }
async function showRewardAd(){ try{ await CG?.ad?.requestAd?.('rewarded'); return true; }catch(_){ return false; } }

/* ========= Splash ========= */
const SPLASH_IMG_URL="./assets/splash.png";
const splash = document.getElementById('splash');
const splashImg = document.getElementById('splashImg');
function hideSplash(){ splash.classList.add('hide'); splash.setAttribute('aria-hidden','true'); setTimeout(()=> splash.style.display='none', 320); }
function showSplash(){ splash.classList.remove('hide'); splash.classList.add('show'); splash.style.display='flex'; splash.setAttribute('aria-hidden','false'); }
try{
  splashImg.src = SPLASH_IMG_URL;
  splashImg.onload = ()=>{ showSplash(); setTimeout(hideSplash, 1400); };
  splashImg.onerror= ()=> hideSplash();
  splash.addEventListener('click', hideSplash);
}catch(_){ hideSplash(); }

/* ========= Mode dialog ========= */
const modeDlg=document.getElementById('modeDlg');
const sizeBtns=[...document.querySelectorAll('.size-btn')];
let chosenSize=4;
sizeBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    sizeBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    chosenSize=+b.dataset.size;
  });
});
[...document.querySelectorAll('.mode-btn')].forEach(btn=>{
  btn.addEventListener('click', ()=> startWithMode(btn.dataset.mode));
});

function openModeDialog(){ modeDlg.style.display='flex'; }
function closeModeDialog(){ modeDlg.style.display='none'; }

/* ========= Game State ========= */
let size=4, grid=[], score=0, best=+localStorage.getItem('best2048_plus')||0;
let mode='classic'; // 'classic' | 'rush' | 'daily'
let undoStack=null, undoLeft=1;
let time=60, timer=null;
let rng=Math.random; // may be seeded for daily
const gridEl=document.getElementById('grid'); const scoreEl=document.getElementById('score'); const bestEl=document.getElementById('best');
const modeLbl=document.getElementById('modeLbl'); const undoLeftEl=document.getElementById('undoLeft');
const timeCard=document.getElementById('timeCard'); const timeLeftEl=document.getElementById('timeLeft');

/* ========= Seeded RNG for Daily ========= */
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function seedFromDate(d=new Date()){ const s=d.toISOString().slice(0,10).replace(/-/g,''); let h=2166136261>>>0; for(const ch of s){ h^=ch.charCodeAt(0); h=Math.imul(h,16777619); } return h>>>0; }

/* ========= Helpers ========= */
function emptyGrid(){ grid=Array.from({length:size},()=>Array(size).fill(0)); }
function randomEmpty(){
  const e=[]; for(let r=0;r<size;r++)for(let c=0;c<size;c++) if(!grid[r][c]) e.push([r,c]);
  return e.length? e[Math.floor(rng()*e.length)] : null;
}
function addTile(){
  const pos=randomEmpty(); if(!pos) return false;
  grid[pos[0]][pos[1]] = rng()<0.9?2:4; return true;
}

/* ========= Setup / Draw ========= */
function setup(){
  if(timer){ clearInterval(timer); timer=null; }
  undoLeft=1; undoStack=null; updateUndoUI();
  timeCard.style.display = (mode==='rush')?'block':'none';
  time = 60; timeLeftEl.textContent=time;

  gridEl.style.gridTemplateColumns = `repeat(${size},1fr)`;
  const cellH = size===5?66: size===3?100:80;
  const style=document.createElement('style'); style.id='dynCell'; style.textContent=`.cell{height:${cellH}px;font-size:${size===5?22: size===3?28:24}px}`;
  const old=document.getElementById('dynCell'); if(old) old.remove(); document.head.appendChild(style);

  emptyGrid(); addTile(); addTile(); score=0; draw();

  if(mode==='rush'){
    timer=setInterval(()=>{
      time--; timeLeftEl.textContent=time;
      if(time<=0){ clearInterval(timer); timer=null; endGame(true); }
    }, 1000);
  }
}

function draw(){
  gridEl.innerHTML=''; scoreEl.textContent=score; bestEl.textContent=best;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    const d=document.createElement('div'); d.className='cell'; d.textContent=v||'';
    d.style.background=v?tileColor(v):'#cdc1b4';
    d.style.color=v>=8?'#f9f6f2':'#776e65';
    gridEl.appendChild(d);
  }
}

function tileColor(v){
  const m={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e',4096:'#3c3a32'};
  return m[v]||'#3c3a32';
}

function pushUndo(){
  if(undoLeft<=0) return;
  undoStack = { grid: grid.map(row=>row.slice()), score };
}

function doUndo(){
  if(!undoStack || undoLeft<=0) return;
  grid = undoStack.grid.map(row=>row.slice());
  score = undoStack.score;
  undoStack=null; undoLeft--; updateUndoUI(); draw();
}

function updateUndoUI(){ undoLeftEl.textContent=undoLeft; }

/* ========= Slide / Move ========= */
function slide(row){
  const f=row.filter(x=>x);
  for(let i=0;i<f.length-1;i++){
    if(f[i]===f[i+1]){
      f[i]*=2; score+=f[i];
      if(mode==='rush'){ time = Math.min(99, time+1); timeLeftEl.textContent=time; }
      f.splice(i+1,1);
    }
  }
  while(f.length<size) f.push(0);
  return f;
}

function rotate(times){
  for(let t=0;t<times;t++){
    const g=Array.from({length:size},()=>Array(size).fill(0));
    for(let r=0;r<size;r++)for(let c=0;c<size;c++) g[c][size-1-r]=grid[r][c];
    grid=g;
  }
}

function move(dir){
  const before=JSON.stringify(grid);
  pushUndo();
  if(dir===2) rotate(2); else if(dir===1) rotate(3); else if(dir===3) rotate(1);
  for(let r=0;r<size;r++) grid[r]=slide(grid[r]);
  if(dir===2) rotate(2); else if(dir===1) rotate(1); else if(dir===3) rotate(3);
  const after=JSON.stringify(grid);
  if(before!==after){ addTile(); updateBest(); draw(); if(gameOver()) endGame(false); }
  else { // لم تتحرك: استرجع الـ undo الذي وضعناه الآن
    undoStack=null;
  }
}

function gameOver(){ if(randomEmpty()) return false;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    if(r+1<size && grid[r+1][c]===v) return false;
    if(c+1<size && grid[r][c+1]===v) return false;
  }
  return true;
}

function updateBest(){ if(score>best){ best=score; localStorage.setItem('best2048_plus',best); } }

/* ========= Inputs ========= */
const startPos={x:0,y:0}; let dragging=false;
function touchStart(e){ dragging=true; const t=e.touches?e.touches[0]:e; startPos.x=t.clientX; startPos.y=t.clientY; }
function touchEnd(e){
  if(!dragging) return; dragging=false;
  const t=e.changedTouches?e.changedTouches[0]:e;
  const dx=t.clientX-startPos.x, dy=t.clientY-startPos.y;
  if(Math.abs(dx)>Math.abs(dy)) move(dx>0?2:0); else move(dy>0?3:1);
}
gridEl.addEventListener('touchstart',touchStart);
gridEl.addEventListener('touchend',touchEnd);
gridEl.addEventListener('mousedown',touchStart);
gridEl.addEventListener('mouseup',touchEnd);

window.addEventListener('keydown', (e)=>{
  const map = { ArrowLeft:0, ArrowUp:1, ArrowRight:2, ArrowDown:3, a:0, w:1, d:2, s:3, A:0, W:1, D:2, S:3 };
  if (e.key in map){ e.preventDefault(); move(map[e.key]); }
});

/* ========= Menu ========= */
const menuBtn=document.getElementById('menuBtn');
const drawer=document.getElementById('drawer');
const backdrop=document.getElementById('backdrop');
document.getElementById('mNew').onclick = ()=>{ closeDrawer(); setup(); };
document.getElementById('mUndo').onclick= ()=>{ closeDrawer(); doUndo(); };
document.getElementById('mMode').onclick= ()=>{ closeDrawer(); openModeDialog(); };
document.getElementById('mAbout').onclick= ()=>{
  closeDrawer();
  alert(`2048 Rush+ — Modes:
• Classic — standard rules.
• Time Rush — 60s timer, +1s per merge.
• Daily Challenge — seeded start changes daily.
• Board sizes — try 3×3 or 5×5.
One undo per run. Local save only. Ads (if any) via CrazyGames SDK.`);
};
function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); }
menuBtn.addEventListener('click', openDrawer);
backdrop.addEventListener('click', closeDrawer);

/* ========= End / Ads ========= */
function endGame(timeUp){
  if(timer){ clearInterval(timer); timer=null; }
  const msg = timeUp ? "Time's up!" : ("Game over! Your score: "+score);
  if(confirm(msg + "\nWatch an ad to continue (undo-like)?")){
    showRewardAd().then(ok=>{
      if(ok && undoLeft>0){ doUndo(); } else { showInterstitialAd().finally(()=> alert("Final score: "+score)); }
    });
  }else{
    showInterstitialAd().finally(()=> alert("Final score: " + score));
  }
}

/* ========= Start flow ========= */
function startWithMode(m){
  mode=m;
  // Size from chooser unless Big Board forced
  size = (m==='classic5') ? 5 : chosenSize;
  // RNG
  if(m==='daily'){ rng = mulberry32(seedFromDate()); } else { rng = Math.random; }
  // Rush timer label
  modeLbl.textContent = m;
  closeModeDialog();
  setup();
}

cgLoadingStart();
window.addEventListener('load', ()=>{
  // Splash
  setTimeout(()=>{ hideSplash(); openModeDialog(); cgLoadingStop(); }, 1200);
});
</script>
</body>
</html>
